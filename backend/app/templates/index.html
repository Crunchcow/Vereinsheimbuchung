<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SV Westfalia Osterwick - Vereinsheim Buchung</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-gradient-start: #c41e3a;
            --bg-gradient-end: #dc143c;
            --card-bg: white;
            --text-color: #333;
            --input-bg: white;
            --input-border: #e9ecef;
            --contact-bar-bg: rgba(255, 255, 255, 0.95);
        }
        
        body.dark-mode {
            --bg-gradient-start: #1a1a1a;
            --bg-gradient-end: #2d2d2d;
            --card-bg: #2a2a2a;
            --text-color: #e0e0e0;
            --input-bg: #3a3a3a;
            --input-border: #4a4a4a;
            --contact-bar-bg: rgba(42, 42, 42, 0.95);
        }
        
        body {
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            position: relative;
            overflow-x: hidden;
        }
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(0, 0, 0, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        .container-wrapper {
            width: 100%;
            max-width: 1000px;
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        .card {
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            background: var(--card-bg);
        }
        .card-header {
            background: linear-gradient(135deg, #c41e3a 0%, #dc143c 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 30px 20px;
            text-align: center;
        }
        .card-header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .card-body {
            padding: 40px;
        }
        .row-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .row-fields {
                grid-template-columns: 1fr;
            }
            .card-body {
                padding: 20px;
            }
            .card-header {
                padding: 20px 15px;
            }
            .card-header h1 {
                font-size: 1.5rem;
            }
            .card-header p {
                font-size: 0.85rem;
            }
            .container-wrapper {
                padding: 10px;
            }
            .form-group {
                margin-bottom: 20px;
            }
        }
        .form-label {
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 10px;
            font-size: 0.95rem;
        }
        .form-control {
            border-radius: 8px;
            border: 2px solid var(--input-border);
            background: var(--input-bg);
            color: var(--text-color);
            padding: 12px 15px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        .form-control:focus {
            border-color: #c41e3a;
            box-shadow: 0 0 0 0.2rem rgba(196, 30, 58, 0.15);
        }
        .form-group {
            margin-bottom: 25px;
        }
        .btn-submit {
            background: linear-gradient(135deg, #c41e3a 0%, #dc143c 100%);
            border: none;
            color: white;
            font-weight: 700;
            padding: 12px 30px;
            border-radius: 8px;
            width: 100%;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(196, 30, 58, 0.3);
        }
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 20, 60, 0.5);
            color: white;
        }
        .btn-submit:active {
            transform: translateY(0);
        }
        .alert {
            border-radius: 8px;
            border: none;
            margin-bottom: 20px;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .alert-danger {
            background-color: #fff5f5;
            color: #c7254e;
        }
        .alert-success {
            background-color: #f0fff4;
            color: #155724;
        }
        .info-text {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-left: 4px solid #c41e3a;
            border-radius: 4px;
            line-height: 1.6;
        }
        .info-text i {
            color: #c41e3a;
            margin-right: 8px;
        }
        
        #occupied-times {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
        }
        #occupied-times h6 {
            font-weight: 700;
            color: #856404;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        #occupied-times .time-slot {
            background-color: white;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 3px solid #ffc107;
            font-size: 0.85rem;
        }
        #occupied-times.loading {
            text-align: center;
            color: #6c757d;
        }
        #occupied-times.free {
            background-color: #d4edda;
            border-color: #28a745;
        }
        #occupied-times.free h6 {
            color: #155724;
        }
        .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        #short-notice-warning {
            animation: slideIn 0.3s ease;
        }
        .contact-bar {
            background: var(--contact-bar-bg);
            padding: 15px 20px;
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            border-bottom: 3px solid rgba(196, 30, 58, 0.2);
        }
        .contact-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-color);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }
        .contact-item:hover {
            color: #c41e3a;
        }
        .contact-item i {
            color: #c41e3a;
            font-size: 1.1rem;
        }
        .timeslot-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .timeslot-btn {
            padding: 10px 15px;
            border: 2px solid var(--input-border);
            background: var(--input-bg);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            text-align: center;
            color: var(--text-color);
        }
        .timeslot-btn:hover {
            border-color: #c41e3a;
            background: rgba(196, 30, 58, 0.05);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .timeslot-btn i {
            color: #c41e3a;
            margin-right: 5px;
        }
        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            border: 2px solid rgba(196, 30, 58, 0.3);
            border-radius: 50px;
            padding: 10px 20px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        .dark-mode-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        .dark-mode-toggle i {
            color: #c41e3a;
            font-size: 1.2rem;
        }
        .summary-item {
            padding: 12px;
            background: var(--input-bg);
            border-left: 3px solid #c41e3a;
            margin: 10px 0;
            border-radius: 4px;
        }
        .summary-item strong {
            color: #c41e3a;
            display: block;
            margin-bottom: 5px;
        }
        .photo-gallery {
            position: relative;
            height: 250px;
            overflow: hidden;
            border-bottom: 3px solid rgba(196, 30, 58, 0.3);
        }
        .carousel-item {
            height: 250px;
        }
        .carousel-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .carousel-caption {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 8px;
        }
        .carousel-control-prev-icon,
        .carousel-control-next-icon {
            background-color: rgba(196, 30, 58, 0.8);
            border-radius: 50%;
            padding: 20px;
        }
        .calendar-container {
            margin: 15px auto;
            max-width: 600px;
            background: var(--input-bg);
            border-radius: 10px;
            padding: 8px;
            border: 2px solid var(--input-border);
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .calendar-header button {
            background: #c41e3a;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }
        .calendar-header button:hover {
            background: #a01630;
        }
        .calendar-header h4 {
            margin: 0;
            color: var(--text-color);
            font-size: 0.9rem;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
        }
        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            padding: 3px 1px;
            color: var(--text-color);
            font-size: 0.7rem;
        }
        .calendar-day {
            aspect-ratio: 1.3;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--card-bg);
            border: 1px solid var(--input-border);
            color: var(--text-color);
            font-size: 0.75rem;
            position: relative;
            min-height: 24px;
        }
        .calendar-day:hover {
            transform: scale(1.03);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .calendar-day:focus {
            outline: 2px solid #c41e3a;
            outline-offset: 2px;
        }
        .calendar-day.other-month {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .calendar-day.today {
            border-color: #c41e3a;
            font-weight: 700;
        }
        .calendar-day.selected {
            background: #c41e3a;
            color: white;
            border-color: #c41e3a;
        }
        .calendar-day.occupied {
            background: rgba(255, 193, 7, 0.2);
            border-color: #ffc107;
        }
        .calendar-day.fully-booked {
            background: rgba(220, 53, 69, 0.2);
            border-color: #dc3545;
            cursor: not-allowed;
        }
        .calendar-day.available {
            background: rgba(40, 167, 69, 0.1);
            border-color: #28a745;
        }
        .calendar-day-indicator {
            position: absolute;
            bottom: 3px;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #c41e3a;
        }
        @media (max-width: 768px) {
            .contact-bar {
                gap: 15px;
                padding: 12px 15px;
            }
            .contact-item {
                font-size: 0.85rem;
            }
            .timeslot-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<!-- Dark Mode Toggle -->
<div class="dark-mode-toggle" onclick="toggleDarkMode()">
    <i class="fas fa-moon" id="darkModeIcon"></i>
</div>

<div class="container-wrapper">
    <div class="card">
        <div class="card-header">
            <h1>
                <i class="fas fa-calendar-check"></i>
                SV Westfalia Osterwick
            </h1>
            <p style="margin: 10px 0 0 0; font-size: 0.95rem; opacity: 0.9;">Vereinsheim Buchung</p>
        </div>
        
        <!-- Foto-Galerie -->
        <div id="photoCarousel" class="carousel slide photo-gallery" data-bs-ride="carousel">
            <div class="carousel-indicators">
                <button type="button" data-bs-target="#photoCarousel" data-bs-slide-to="0" class="active" aria-current="true"></button>
                <button type="button" data-bs-target="#photoCarousel" data-bs-slide-to="1"></button>
                <button type="button" data-bs-target="#photoCarousel" data-bs-slide-to="2"></button>
            </div>
            <div class="carousel-inner">
                <div class="carousel-item active">
                    <!-- Ersetze src mit echtem Foto vom Außenbereich -->
                    <img src="https://images.unsplash.com/photo-1511184150666-9bb7d41a88f4?w=800&auto=format&fit=crop" alt="Vereinsheim Außenansicht">
                    <div class="carousel-caption">
                        <h5>Unser Vereinsheim</h5>
                        <p>Der perfekte Ort für deine Feier</p>
                    </div>
                </div>
                <div class="carousel-item">
                    <!-- Ersetze src mit echtem Foto vom Innenbereich -->
                    <img src="https://images.unsplash.com/photo-1555854877-bab0e564b8d5?w=800&auto=format&fit=crop" alt="Vereinsheim Innenbereich">
                    <div class="carousel-caption">
                        <h5>Großzügiger Innenraum</h5>
                        <p>Platz für bis zu 80 Personen</p>
                    </div>
                </div>
                <div class="carousel-item">
                    <!-- Ersetze src mit echtem Foto von Feier/Event -->
                    <img src="https://images.unsplash.com/photo-1464366400600-7168b8af9bc3?w=800&auto=format&fit=crop" alt="Event im Vereinsheim">
                    <div class="carousel-caption">
                        <h5>Für jeden Anlass</h5>
                        <p>Geburtstage, Mannschaftsabende & mehr</p>
                    </div>
                </div>
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#photoCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Zurück</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#photoCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Weiter</span>
            </button>
        </div>
        
        <!-- Kontaktinformationen -->
        <div class="contact-bar">
            <a href="tel:+4916091778450" class="contact-item">
                <i class="fas fa-phone"></i>
                <span>+49 160 91778450</span>
            </a>
            <a href="mailto:sportheim@westfalia-osterwick.de" class="contact-item">
                <i class="fas fa-envelope"></i>
                <span>sportheim@westfalia-osterwick.de</span>
            </a>
            <div class="contact-item">
                <i class="fas fa-info-circle"></i>
                <span>Buchung mind. 14 Tage im Voraus</span>
            </div>
        </div>
        
        <div class="card-body">
            {% if error %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle"></i>
                <strong>Fehler:</strong> {{ error }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}
            
            {% if success %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle"></i>
                <strong>Erfolg!</strong> {{ success }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}
            
            <form action="/check" method="post" id="bookingForm">
                <!-- Zeile 1: Name + Anlass -->
                <div class="row-fields">
                    <div class="form-group">
                        <label for="name" class="form-label">
                            <i class="fas fa-user"></i> 1. Bitte gib hier deinen Namen an <span style="color: red;">*</span>
                        </label>
                        <input type="text" class="form-control" id="name" name="name" placeholder="Dein Name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="purpose" class="form-label">
                            <i class="fas fa-comment-dots"></i> 2. Was ist der Anlass der Buchung? <span style="color: red;">*</span>
                        </label>
                        <input type="text" class="form-control" id="purpose" name="purpose" placeholder="z.B. Mannschaftsabend" required>
                    </div>
                </div>
                
                <!-- Zeile 2: Email + Telefon -->
                <div class="row-fields">
                    <div class="form-group">
                        <label for="email" class="form-label">
                            <i class="fas fa-envelope"></i> 3. Bitte gib hier eine Mail-Adresse an <span style="color: red;">*</span>
                        </label>
                        <input type="email" class="form-control" id="email" name="email" placeholder="deine.email@beispiel.de" required>
                        <small class="text-muted">Für die Buchungsbestätigung</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="phone" class="form-label">
                            <i class="fas fa-phone"></i> 4. Bitte gib uns eine Rufnummer für eventuelle Rückfragen (optional)
                        </label>
                        <input type="tel" class="form-control" id="phone" name="phone" placeholder="z.B. 0123 456789">
                    </div>
                </div>
                
                <!-- Visueller Kalender -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-calendar"></i> 5. Wähle das Datum der Buchung <span style="color: red;">*</span>
                    </label>
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <button type="button" onclick="changeMonth(-1)">
                                <i class="fas fa-chevron-left"></i> Zurück
                            </button>
                            <h4 id="currentMonthYear"></h4>
                            <button type="button" onclick="changeMonth(1)">
                                Weiter <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="calendar-grid">
                            <div class="calendar-day-header">Mo</div>
                            <div class="calendar-day-header">Di</div>
                            <div class="calendar-day-header">Mi</div>
                            <div class="calendar-day-header">Do</div>
                            <div class="calendar-day-header">Fr</div>
                            <div class="calendar-day-header">Sa</div>
                            <div class="calendar-day-header">So</div>
                            <!-- Calendar days will be generated by JavaScript -->
                            <div id="calendarDays"></div>
                        </div>
                    </div>
                    <!-- Hidden date input for form submission -->
                    <input type="date" class="form-control" id="date" name="date" required style="display: none;">
                    
                    <!-- Anzeige für belegte Zeiten -->
                    <div id="occupied-times" class="mt-3" style="display: none;"></div>
                </div>
                
                <!-- Zeitslot-Schnellauswahl -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-bolt"></i> Schnellauswahl Zeitslots
                    </label>
                    <div class="timeslot-buttons">
                        <button type="button" class="timeslot-btn" onclick="setTimeSlot('09:00', '13:00')">
                            <i class="fas fa-sun"></i> Vormittag<br><small>09:00 - 13:00</small>
                        </button>
                        <button type="button" class="timeslot-btn" onclick="setTimeSlot('14:00', '18:00')">
                            <i class="fas fa-cloud-sun"></i> Nachmittag<br><small>14:00 - 18:00</small>
                        </button>
                        <button type="button" class="timeslot-btn" onclick="setTimeSlot('18:00', '22:00')">
                            <i class="fas fa-moon"></i> Abend<br><small>18:00 - 22:00</small>
                        </button>
                        <button type="button" class="timeslot-btn" onclick="setTimeSlot('09:00', '22:00')">
                            <i class="fas fa-calendar-day"></i> Ganzer Tag<br><small>09:00 - 22:00</small>
                        </button>
                    </div>
                </div>
                
                <!-- Zeile 3: Startzeit + Endzeit -->
                <div class="row-fields">
                    <div class="form-group">
                        <label for="start" class="form-label">
                            <i class="fas fa-clock"></i> 6. Startzeit <span style="color: red;">*</span>
                        </label>
                        <input type="time" class="form-control" id="start" name="start" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="end" class="form-label">
                            <i class="fas fa-clock"></i> 7. Endzeit <span style="color: red;">*</span>
                        </label>
                        <input type="time" class="form-control" id="end" name="end" required>
                    </div>
                </div>
                
                <!-- Datenschutzhinweis -->
                <div class="form-group" style="margin-top: 30px; padding: 20px; background-color: #f8f9fa; border-radius: 8px;">
                    <h6 style="font-weight: 700; margin-bottom: 15px;">
                        <i class="fas fa-shield-alt"></i> Hinweis zur Datenverarbeitung
                    </h6>
                    <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">
                        8. Ich bin damit einverstanden, dass meine angegebenen Daten im Rahmen der Buchungsanfrage für das Vereinsheim von Westfalia Osterwick verarbeitet und gespeichert werden. Die Daten werden ausschließlich zur Terminverwaltung und ggf. zur Kontaktaufnahme im Zusammenhang mit dieser Anfrage verwendet. Eine Weitergabe an Dritte erfolgt nicht. Weitere Informationen finden Sie in unserer <a href="/datenschutz" target="_blank" rel="noopener noreferrer" style="color: #c41e3a; font-weight: 600;">Datenschutzerklärung</a>. <span style="color: red;">*</span>
                    </p>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="privacy" name="privacy" required style="border: 2px solid #c41e3a;">
                        <label class="form-check-label" for="privacy" style="font-size: 0.95rem;">
                            <strong>Ja, ich habe die Datenschutzerklärung gelesen und stimme der Datenverarbeitung zu.</strong>
                        </label>
                    </div>
                </div>
                
                <!-- Warnung für kurzfristige Buchungen -->
                <div id="short-notice-warning" class="alert alert-warning" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Kurzfristige Buchung nicht möglich!</strong><br>
                    Buchungen müssen mindestens 14 Tage im Voraus erfolgen. Bitte wende dich für eine kurzfristige Buchung an Peter Fedders oder Eike Nonhoff.
                </div>
                
                <button type="submit" class="btn btn-submit" id="submitBtn">
                    <i class="fas fa-check"></i> Buchen
                </button>
            </form>
            
            <div class="info-text">
                <i class="fas fa-info-circle"></i>
                <strong>Wichtig:</strong> Buchungen müssen mindestens 14 Tage im Voraus erfolgen. Bei kurzfristigen Anfragen kontaktiere bitte Peter Fedders oder Eike Nonhoff.<br>
                <small>Du erhältst eine Bestätigungsmail an die angegebene E-Mail-Adresse.</small>
            </div>
        </div>
    </div>
</div>

<!-- Zusammenfassungs-Modal -->
<div class="modal fade" id="summaryModal" tabindex="-1" aria-labelledby="summaryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #c41e3a 0%, #dc143c 100%); color: white;">
                <h5 class="modal-title" id="summaryModalLabel">
                    <i class="fas fa-clipboard-check"></i> Buchung überprüfen
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Bitte überprüfe deine Angaben:</strong></p>
                
                <div class="summary-item">
                    <strong><i class="fas fa-user"></i> Name</strong>
                    <span id="summary-name"></span>
                </div>
                
                <div class="summary-item">
                    <strong><i class="fas fa-comment-dots"></i> Anlass</strong>
                    <span id="summary-purpose"></span>
                </div>
                
                <div class="summary-item">
                    <strong><i class="fas fa-envelope"></i> E-Mail</strong>
                    <span id="summary-email"></span>
                </div>
                
                <div class="summary-item" id="summary-phone-container" style="display: none;">
                    <strong><i class="fas fa-phone"></i> Telefon</strong>
                    <span id="summary-phone"></span>
                </div>
                
                <div class="summary-item">
                    <strong><i class="fas fa-calendar"></i> Datum</strong>
                    <span id="summary-date"></span>
                </div>
                
                <div class="summary-item">
                    <strong><i class="fas fa-clock"></i> Zeit</strong>
                    <span id="summary-time"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Abbrechen
                </button>
                <button type="button" class="btn btn-submit" onclick="confirmBooking()" style="width: auto;">
                    <i class="fas fa-check"></i> Jetzt verbindlich buchen
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Calendar State
    let currentCalendarDate = new Date();
    let monthBookings = {};
    
    // Render Calendar
    function renderCalendar() {
        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();
        
        // Update header
        const monthNames = ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 
                           'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
        document.getElementById('currentMonthYear').textContent = `${monthNames[month]} ${year}`;
        
        // Get first day of month (0 = Sunday, need to convert to Monday = 0)
        const firstDay = new Date(year, month, 1);
        let startDay = firstDay.getDay();
        startDay = startDay === 0 ? 6 : startDay - 1; // Convert to Monday = 0
        
        // Get days in month
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();
        
        // Build calendar grid
        const calendarDays = document.getElementById('calendarDays');
        calendarDays.innerHTML = '';
        calendarDays.style.display = 'contents';
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const minDate = new Date();
        minDate.setDate(today.getDate() + 14);
        minDate.setHours(0, 0, 0, 0);
        
        // Previous month days
        for (let i = startDay - 1; i >= 0; i--) {
            const day = daysInPrevMonth - i;
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day other-month';
            dayEl.textContent = day;
            calendarDays.appendChild(dayEl);
        }
        
        // Current month days
        for (let day = 1; day <= daysInMonth; day++) {
            const dayDate = new Date(year, month, day);
            dayDate.setHours(0, 0, 0, 0);
            
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';
            dayEl.textContent = day;
            
            // Today marker
            if (dayDate.getTime() === today.getTime()) {
                dayEl.classList.add('today');
            }
            
            // Check if selectable (14 days rule)
            if (dayDate < minDate) {
                dayEl.classList.add('other-month');
                dayEl.style.cursor = 'not-allowed';
                dayEl.title = 'Buchung nur 14+ Tage im Voraus';
                dayEl.setAttribute('aria-disabled', 'true');
            } else {
                // Make clickable and accessible
                const dateStr = dayDate.toISOString().split('T')[0];
                const formattedDate = dayDate.toLocaleDateString('de-DE', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
                
                dayEl.onclick = () => selectDate(dateStr);
                dayEl.setAttribute('role', 'button');
                dayEl.setAttribute('tabindex', '0');
                dayEl.setAttribute('aria-label', `${formattedDate} auswählen`);
                
                // Keyboard support
                dayEl.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        selectDate(dateStr);
                    }
                });
                
                // Check if has bookings
                if (monthBookings[dateStr]) {
                    dayEl.classList.add('occupied');
                    dayEl.setAttribute('aria-label', `${formattedDate} auswählen (teilweise belegt)`);
                    const indicator = document.createElement('div');
                    indicator.className = 'calendar-day-indicator';
                    indicator.setAttribute('aria-hidden', 'true');
                    dayEl.appendChild(indicator);
                }
            }
            
            calendarDays.appendChild(dayEl);
        }
        
        // Next month days
        const totalCells = startDay + daysInMonth;
        const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
        for (let day = 1; day <= remainingCells; day++) {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day other-month';
            dayEl.textContent = day;
            calendarDays.appendChild(dayEl);
        }
    }
    
    function changeMonth(direction) {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
        renderCalendar();
        loadMonthBookings();
    }
    
    function selectDate(dateStr) {
        // Update hidden field
        document.getElementById('date').value = dateStr;
        
        // Visual feedback
        document.querySelectorAll('.calendar-day').forEach(el => {
            el.classList.remove('selected');
        });
        event.target.classList.add('selected');
        
        // Trigger availability check
        document.getElementById('date').dispatchEvent(new Event('change'));
        checkDateValidity();
    }
    
    async function loadMonthBookings() {
        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth() + 1; // JS months are 0-indexed
        
        try {
            const response = await fetch(`/api/month-bookings?year=${year}&month=${month}`);
            if (response.ok) {
                monthBookings = await response.json();
                renderCalendar();
            }
        } catch (error) {
            console.error('Failed to load month bookings:', error);
            renderCalendar();
        }
    }
    
    // Initialize calendar
    renderCalendar();
    loadMonthBookings();
    
    // Dark Mode Toggle
    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        const icon = document.getElementById('darkModeIcon');
        
        if (isDark) {
            icon.className = 'fas fa-sun';
            localStorage.setItem('darkMode', 'enabled');
        } else {
            icon.className = 'fas fa-moon';
            localStorage.setItem('darkMode', 'disabled');
        }
    }
    
    // Check for saved dark mode preference
    if (localStorage.getItem('darkMode') === 'enabled') {
        document.body.classList.add('dark-mode');
        document.getElementById('darkModeIcon').className = 'fas fa-sun';
    }
    
    // Form submission with summary modal
    const bookingForm = document.getElementById('bookingForm');
    let summaryModal;
    
    bookingForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate time slots before opening modal
        const startTime = document.getElementById('start').value;
        const endTime = document.getElementById('end').value;
        const validation = validateTimeSlot(startTime, endTime);
        
        if (!validation.valid) {
            // Show error message
            alert(validation.message);
            return;
        }
        
        // Fill summary modal
        document.getElementById('summary-name').textContent = document.getElementById('name').value;
        document.getElementById('summary-purpose').textContent = document.getElementById('purpose').value;
        document.getElementById('summary-email').textContent = document.getElementById('email').value;
        
        const phone = document.getElementById('phone').value;
        if (phone) {
            document.getElementById('summary-phone').textContent = phone;
            document.getElementById('summary-phone-container').style.display = 'block';
        } else {
            document.getElementById('summary-phone-container').style.display = 'none';
        }
        
        const dateValue = document.getElementById('date').value;
        const dateObj = new Date(dateValue);
        const formattedDate = dateObj.toLocaleDateString('de-DE', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        document.getElementById('summary-date').textContent = formattedDate;
        
        document.getElementById('summary-time').textContent = `${startTime} - ${endTime} Uhr`;
        
        // Show modal
        summaryModal = new bootstrap.Modal(document.getElementById('summaryModal'));
        summaryModal.show();
    });
    
    function confirmBooking() {
        summaryModal.hide();
        // Submit form after modal closes
        setTimeout(() => {
            bookingForm.submit();
        }, 300);
    }
    
    // Set time slot from quick selection
    function setTimeSlot(start, end) {
        document.getElementById('start').value = start;
        document.getElementById('end').value = end;
        
        // Visual feedback
        const buttons = document.querySelectorAll('.timeslot-btn');
        buttons.forEach(btn => btn.style.background = 'white');
        event.target.closest('.timeslot-btn').style.background = 'rgba(196, 30, 58, 0.1)';
    }
    
    // Check availability when date is selected
    const dateInput = document.getElementById('date');
    const occupiedTimesDiv = document.getElementById('occupied-times');
    const submitBtn = document.getElementById('submitBtn');
    const shortNoticeWarning = document.getElementById('short-notice-warning');
    
    // Store occupied times for validation
    let currentOccupiedTimes = [];
    
    // Validate if selected times overlap with occupied times
    function validateTimeSlot(startTime, endTime) {
        if (!startTime || !endTime || currentOccupiedTimes.length === 0) {
            return { valid: true };
        }
        
        // Convert times to minutes for comparison
        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }
        
        const requestStart = timeToMinutes(startTime);
        const requestEnd = timeToMinutes(endTime);
        
        // Check for overlaps (but allow exact borders)
        for (const occupied of currentOccupiedTimes) {
            const occupiedStart = timeToMinutes(occupied.start);
            const occupiedEnd = timeToMinutes(occupied.end);
            
            // Check if there's an overlap
            const hasOverlap = (requestStart < occupiedEnd && requestEnd > occupiedStart);
            // Check if they just touch at the border
            const isExactBorder = (requestStart === occupiedEnd || requestEnd === occupiedStart);
            
            // Conflict only if overlapping but not just bordering
            if (hasOverlap && !isExactBorder) {
                return {
                    valid: false,
                    message: `Die gewählte Zeit überschneidet sich mit einem bereits gebuchten Termin (${occupied.start} - ${occupied.end} Uhr).`
                };
            }
        }
        
        return { valid: true };
    }
    
    // Check if date is within 14 days
    function checkDateValidity() {
        const selectedDate = dateInput.value;
        
        if (!selectedDate) {
            submitBtn.disabled = false;
            shortNoticeWarning.style.display = 'none';
            return true;
        }
        
        const selected = new Date(selectedDate);
        const today = new Date();
        const minDate = new Date();
        minDate.setDate(today.getDate() + 14);
        
        // Reset time to compare only dates
        selected.setHours(0, 0, 0, 0);
        minDate.setHours(0, 0, 0, 0);
        
        if (selected < minDate) {
            // Too short notice
            submitBtn.disabled = true;
            shortNoticeWarning.style.display = 'block';
            return false;
        } else {
            submitBtn.disabled = false;
            shortNoticeWarning.style.display = 'none';
            return true;
        }
    }
    
    dateInput.addEventListener('change', async function() {
        const selectedDate = this.value;
        
        // Check 14-day rule
        checkDateValidity();
        
        if (!selectedDate) {
            occupiedTimesDiv.style.display = 'none';
            return;
        }
        
        // Show loading state
        occupiedTimesDiv.style.display = 'block';
        occupiedTimesDiv.className = 'mt-3 loading';
        occupiedTimesDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Prüfe Verfügbarkeit...';
        
        try {
            const response = await fetch(`/api/availability?date=${selectedDate}`);
            const data = await response.json();
            
            if (data.error) {
                occupiedTimesDiv.innerHTML = `<h6><i class="fas fa-exclamation-triangle"></i> Fehler</h6><p>${data.error}</p>`;
                return;
            }
            
            const occupied = data.occupied || [];
            
            // Store for validation
            currentOccupiedTimes = occupied;
            
            if (occupied.length === 0) {
                // No bookings - day is free
                occupiedTimesDiv.className = 'mt-3 free';
                occupiedTimesDiv.innerHTML = '<h6><i class="fas fa-check-circle"></i> Verfügbar</h6><p style="margin:0; font-size: 0.85rem;">An diesem Tag sind keine Termine belegt.</p>';
            } else {
                // Show occupied times
                occupiedTimesDiv.className = 'mt-3';
                let html = '<h6><i class="fas fa-exclamation-circle"></i> Bereits belegt:</h6>';
                occupied.forEach(event => {
                    html += `<div class="time-slot"><i class="fas fa-clock"></i> ${event.start} - ${event.end} Uhr</div>`;
                });
                occupiedTimesDiv.innerHTML = html;
            }
        } catch (error) {
            occupiedTimesDiv.className = 'mt-3';
            occupiedTimesDiv.innerHTML = '<h6><i class="fas fa-exclamation-triangle"></i> Fehler</h6><p style="margin:0; font-size: 0.85rem;">Verbindung fehlgeschlagen. Bitte versuchen Sie es erneut.</p>';
        }
    });
</script>
</body>
</html>