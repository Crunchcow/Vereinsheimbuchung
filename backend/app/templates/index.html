<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SV Westfalia Osterwick - Vereinsheim Buchung</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #c41e3a 0%, #dc143c 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            position: relative;
            overflow-x: hidden;
        }
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(0, 0, 0, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        .container-wrapper {
            width: 100%;
            max-width: 500px;
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        .card {
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            background: white;
        }
        .card-header {
            background: linear-gradient(135deg, #c41e3a 0%, #dc143c 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 30px 20px;
            text-align: center;
        }
        .card-header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .card-body {
            padding: 40px;
        }
        .form-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }
        .form-control {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        .form-control:focus {
            border-color: #c41e3a;
            box-shadow: 0 0 0 0.2rem rgba(196, 30, 58, 0.15);
        }
        .form-group {
            margin-bottom: 25px;
        }
        .btn-submit {
            background: linear-gradient(135deg, #c41e3a 0%, #dc143c 100%);
            border: none;
            color: white;
            font-weight: 700;
            padding: 12px 30px;
            border-radius: 8px;
            width: 100%;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(196, 30, 58, 0.3);
        }
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 20, 60, 0.5);
            color: white;
        }
        .btn-submit:active {
            transform: translateY(0);
        }
        .alert {
            border-radius: 8px;
            border: none;
            margin-bottom: 20px;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .alert-danger {
            background-color: #fff5f5;
            color: #c7254e;
        }
        .alert-success {
            background-color: #f0fff4;
            color: #155724;
        }
        .info-text {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-left: 4px solid #c41e3a;
            border-radius: 4px;
            line-height: 1.6;
        }
        .info-text i {
            color: #c41e3a;
            margin-right: 8px;
        }
        
        #occupied-times {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
        }
        #occupied-times h6 {
            font-weight: 700;
            color: #856404;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        #occupied-times .time-slot {
            background-color: white;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 3px solid #ffc107;
            font-size: 0.85rem;
        }
        #occupied-times.loading {
            text-align: center;
            color: #6c757d;
        }
        #occupied-times.free {
            background-color: #d4edda;
            border-color: #28a745;
        }
        #occupied-times.free h6 {
            color: #155724;
        }
        .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        #short-notice-warning {
            animation: slideIn 0.3s ease;
        }
    </style>
</head>
<body>
<div class="container-wrapper">
    <div class="card">
        <div class="card-header">
            <h1>
                <i class="fas fa-calendar-check"></i>
                SV Westfalia Osterwick
            </h1>
            <p style="margin: 10px 0 0 0; font-size: 0.95rem; opacity: 0.9;">Vereinsheim Buchung</p>
        </div>
        <div class="card-body">
            {% if error %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle"></i>
                <strong>Fehler:</strong> {{ error }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}
            
            {% if success %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle"></i>
                <strong>Erfolg!</strong> {{ success }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}
            
            <form action="/check" method="post" id="bookingForm">
                <div class="form-group">
                    <label for="name" class="form-label">
                        <i class="fas fa-user"></i> 1. Bitte gib hier deinen Namen an <span style="color: red;">*</span>
                    </label>
                    <input type="text" class="form-control" id="name" name="name" placeholder="Dein Name" required>
                </div>
                
                <div class="form-group">
                    <label for="purpose" class="form-label">
                        <i class="fas fa-comment-dots"></i> 2. Was ist der Anlass der Buchung? <span style="color: red;">*</span>
                    </label>
                    <input type="text" class="form-control" id="purpose" name="purpose" placeholder="z.B. Mannschaftsabend" required>
                </div>
                
                <div class="form-group">
                    <label for="email" class="form-label">
                        <i class="fas fa-envelope"></i> 3. Bitte gib hier eine Mail-Adresse an <span style="color: red;">*</span>
                    </label>
                    <input type="email" class="form-control" id="email" name="email" placeholder="deine.email@beispiel.de" required>
                    <small class="text-muted">Für die Buchungsbestätigung</small>
                </div>
                
                <div class="form-group">
                    <label for="phone" class="form-label">
                        <i class="fas fa-phone"></i> 4. Bitte gib uns eine Rufnummer für eventuelle Rückfragen (optional)
                    </label>
                    <input type="tel" class="form-control" id="phone" name="phone" placeholder="z.B. 0123 456789">
                </div>
                
                <div class="form-group">
                    <label for="date" class="form-label">
                        <i class="fas fa-calendar"></i> 5. Bitte gib das Datum der Buchung an <span style="color: red;">*</span>
                    </label>
                    <input type="date" class="form-control" id="date" name="date" required>
                    
                    <!-- Anzeige für belegte Zeiten -->
                    <div id="occupied-times" class="mt-3" style="display: none;"></div>
                </div>
                
                <div class="form-group">
                    <label for="start" class="form-label">
                        <i class="fas fa-clock"></i> 6. Startzeit <span style="color: red;">*</span>
                    </label>
                    <input type="time" class="form-control" id="start" name="start" required>
                </div>
                
                <div class="form-group">
                    <label for="end" class="form-label">
                        <i class="fas fa-clock"></i> 7. Endzeit <span style="color: red;">*</span>
                    </label>
                    <input type="time" class="form-control" id="end" name="end" required>
                </div>
                
                <!-- Datenschutzhinweis -->
                <div class="form-group" style="margin-top: 30px; padding: 20px; background-color: #f8f9fa; border-radius: 8px;">
                    <h6 style="font-weight: 700; margin-bottom: 15px;">
                        <i class="fas fa-shield-alt"></i> Hinweis zur Datenverarbeitung
                    </h6>
                    <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px;">
                        8. Ich bin damit einverstanden, dass meine angegebenen Daten im Rahmen der Buchungsanfrage für das Vereinsheim von Westfalia Osterwick verarbeitet und gespeichert werden. Die Daten werden ausschließlich zur Terminverwaltung und ggf. zur Kontaktaufnahme im Zusammenhang mit dieser Anfrage verwendet. Eine Weitergabe an Dritte erfolgt nicht. <span style="color: red;">*</span>
                    </p>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="privacy" name="privacy" required style="border: 2px solid #c41e3a;">
                        <label class="form-check-label" for="privacy" style="font-size: 0.95rem;">
                            <strong>Ja, ich stimme zu.</strong>
                        </label>
                    </div>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" id="privacy-no" disabled>
                        <label class="form-check-label" for="privacy-no" style="font-size: 0.95rem; color: #6c757d;">
                            Nein, ich stimme nicht zu.
                        </label>
                    </div>
                </div>
                
                <!-- Warnung für kurzfristige Buchungen -->
                <div id="short-notice-warning" class="alert alert-warning" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Kurzfristige Buchung nicht möglich!</strong><br>
                    Buchungen müssen mindestens 14 Tage im Voraus erfolgen. Bitte wende dich für eine kurzfristige Buchung an Peter Fedders oder Eike Nonhoff.
                </div>
                
                <button type="submit" class="btn btn-submit" id="submitBtn">
                    <i class="fas fa-check"></i> Prüfen und Buchen
                </button>
            </form>
            
            <div class="info-text">
                <i class="fas fa-info-circle"></i>
                <strong>Wichtig:</strong> Buchungen müssen mindestens 14 Tage im Voraus erfolgen. Bei kurzfristigen Anfragen kontaktiere bitte Peter Fedders oder Eike Nonhoff.<br>
                <small>Du erhältst eine Bestätigungsmail an die angegebene E-Mail-Adresse.</small>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Check availability when date is selected
    const dateInput = document.getElementById('date');
    const occupiedTimesDiv = document.getElementById('occupied-times');
    const submitBtn = document.getElementById('submitBtn');
    const shortNoticeWarning = document.getElementById('short-notice-warning');
    const bookingForm = document.getElementById('bookingForm');
    
    // Check if date is within 14 days
    function checkDateValidity() {
        const selectedDate = dateInput.value;
        
        if (!selectedDate) {
            submitBtn.disabled = false;
            shortNoticeWarning.style.display = 'none';
            return true;
        }
        
        const selected = new Date(selectedDate);
        const today = new Date();
        const minDate = new Date();
        minDate.setDate(today.getDate() + 14);
        
        // Reset time to compare only dates
        selected.setHours(0, 0, 0, 0);
        minDate.setHours(0, 0, 0, 0);
        
        if (selected < minDate) {
            // Too short notice
            submitBtn.disabled = true;
            shortNoticeWarning.style.display = 'block';
            return false;
        } else {
            submitBtn.disabled = false;
            shortNoticeWarning.style.display = 'none';
            return true;
        }
    }
    
    dateInput.addEventListener('change', async function() {
        const selectedDate = this.value;
        
        // Check 14-day rule
        checkDateValidity();
        
        if (!selectedDate) {
            occupiedTimesDiv.style.display = 'none';
            return;
        }
        
        // Show loading state
        occupiedTimesDiv.style.display = 'block';
        occupiedTimesDiv.className = 'mt-3 loading';
        occupiedTimesDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Prüfe Verfügbarkeit...';
        
        try {
            const response = await fetch(`/api/availability?date=${selectedDate}`);
            const data = await response.json();
            
            if (data.error) {
                occupiedTimesDiv.innerHTML = `<h6><i class="fas fa-exclamation-triangle"></i> Fehler</h6><p>${data.error}</p>`;
                return;
            }
            
            const occupied = data.occupied || [];
            
            if (occupied.length === 0) {
                // No bookings - day is free
                occupiedTimesDiv.className = 'mt-3 free';
                occupiedTimesDiv.innerHTML = '<h6><i class="fas fa-check-circle"></i> Verfügbar</h6><p style="margin:0; font-size: 0.85rem;">An diesem Tag sind keine Termine belegt.</p>';
            } else {
                // Show occupied times
                occupiedTimesDiv.className = 'mt-3';
                let html = '<h6><i class="fas fa-exclamation-circle"></i> Bereits belegt:</h6>';
                occupied.forEach(event => {
                    html += `<div class="time-slot"><i class="fas fa-clock"></i> ${event.start} - ${event.end} Uhr</div>`;
                });
                occupiedTimesDiv.innerHTML = html;
            }
        } catch (error) {
            occupiedTimesDiv.className = 'mt-3';
            occupiedTimesDiv.innerHTML = '<h6><i class="fas fa-exclamation-triangle"></i> Fehler</h6><p style="margin:0; font-size: 0.85rem;">Verbindung fehlgeschlagen. Bitte versuchen Sie es erneut.</p>';
        }
    });
</script>
</body>
</html>